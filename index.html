<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI MUSIC BEAST - ULTRA STUDIO PRO V5.5</title>
    <!-- Essential Libraries & High-Performance Scripts -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /**
         * AI MUSIC BEAST - DESIGN SYSTEM
         * Version: 5.5 Professional
         * Author: Gemini AI Engineering
         */
        :root {
            --bg-base: #020205;
            --bg-surface: #0a0a14;
            --bg-element: #121222;
            --accent-primary: #00f2ff;
            --accent-secondary: #7000ff;
            --accent-success: #39ff14;
            --accent-danger: #ff0055;
            --accent-warning: #ffcc00;
            --text-main: #f0f0f5;
            --text-dim: #9494a5;
            --border: #1e1e35;
            --border-glow: rgba(0, 242, 255, 0.15);
            --shadow-neon: 0 0 25px rgba(0, 242, 255, 0.15);
            --transition-speed: 0.25s;
        }

        /* Global Reset & Base Styles */
        * { 
            box-sizing: border-box; 
            outline: none; 
            transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1); 
            user-select: none;
        }
        
        body {
            background: var(--bg-base);
            color: var(--text-main);
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            letter-spacing: -0.01em;
        }

        /* Layout Architecture */
        .app-shell {
            display: grid;
            grid-template-columns: 380px 1fr;
            grid-template-rows: 70px 1fr 220px;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at 50% 50%, #0a0a1f 0%, #020205 100%);
        }

        /* Navigation Header */
        header {
            grid-column: 1 / -1;
            background: rgba(10, 10, 20, 0.9);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 35px;
            z-index: 1000;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px var(--accent-primary);
        }

        .brand h1 {
            font-size: 1.4rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            background: linear-gradient(90deg, #fff, var(--accent-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            font-weight: 800;
        }

        .engine-status {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-pill {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-pill.active { border-color: var(--accent-success); color: var(--accent-success); }

        /* Sidebar Control Panel */
        aside {
            grid-row: 2 / -1;
            background: var(--bg-surface);
            border-left: 1px solid var(--border);
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .config-section-title {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 5px;
            font-weight: 800;
        }

        .config-card {
            background: var(--bg-element);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px;
            position: relative;
        }

        .config-card:hover { border-color: var(--accent-primary); box-shadow: var(--shadow-neon); }

        .config-card label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--accent-primary);
            margin-bottom: 12px;
            font-weight: 700;
        }

        .input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        input, textarea, select {
            width: 100%;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: #fff;
            padding: 12px 15px;
            font-size: 0.9rem;
            font-family: inherit;
        }

        input:focus, textarea:focus { border-color: var(--accent-primary); background: rgba(0,0,0,0.6); }

        .toggle-password {
            position: absolute;
            left: 10px;
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-password:hover { color: var(--accent-primary); }

        /* Buttons & Interactions */
        .btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            font-size: 0.85rem;
            position: relative;
            overflow: hidden;
        }

        .btn-ai { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: #000; box-shadow: 0 4px 15px rgba(0, 242, 255, 0.3); }
        .btn-play { background: var(--accent-success); color: #000; }
        .btn-stop { background: var(--accent-danger); color: #fff; }
        .btn-download { background: #fff; color: #000; }
        
        .btn:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.1); }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }

        /* Main Workspace */
        main {
            grid-row: 2 / 3;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .visualizer-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 300px;
        }

        .monitor {
            background: #000;
            border-radius: 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .monitor-label {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 0.65rem;
            color: var(--accent-primary);
            background: rgba(0,0,0,0.7);
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid rgba(0, 242, 255, 0.3);
            font-weight: 800;
        }

        canvas { width: 100%; height: 100%; display: block; }

        /* Mixer Controls */
        .mixer-board {
            background: var(--bg-element);
            border-radius: 24px;
            padding: 25px;
            border: 1px solid var(--border);
            flex-grow: 1;
        }

        .mixer-channels {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .strip {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0,0,0,0.2);
            padding: 15px 5px;
            border-radius: 14px;
            border: 1px solid var(--border);
        }

        .v-meter {
            width: 8px;
            height: 120px;
            background: #080808;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            border: 1px solid #1a1a1a;
        }

        .v-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top, #00ff00, #ffff00, #ff0000);
            box-shadow: 0 0 10px rgba(0,255,0,0.5);
        }

        .fader-vertical {
            writing-mode: bt-lr; 
            -webkit-appearance: slider-vertical;
            width: 20px;
            height: 80px;
            margin: 10px 0;
            cursor: pointer;
        }

        .strip-label {
            font-size: 0.6rem;
            font-weight: 900;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        /* Timeline & Sequence */
        .timeline-area {
            grid-column: 2 / 3;
            grid-row: 3 / 4;
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
            padding: 20px;
            overflow-x: auto;
            display: flex;
            align-items: center;
        }

        .track-wrapper {
            display: flex;
            gap: 12px;
            padding: 10px;
            background: #05050a;
            border-radius: 16px;
            border: 1px solid var(--border);
            min-width: 100%;
        }

        .pattern-block {
            min-width: 160px;
            background: var(--bg-element);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            position: relative;
        }

        .pattern-block.active {
            border-color: var(--accent-primary);
            background: rgba(0, 242, 255, 0.05);
            box-shadow: inset 0 0 15px rgba(0, 242, 255, 0.1);
        }

        /* Console & Logs */
        .terminal-log {
            background: #000;
            border: 1px solid var(--border);
            border-radius: 10px;
            height: 120px;
            padding: 12px;
            font-family: 'Consolas', monospace;
            font-size: 0.75rem;
            color: #00ffaa;
            overflow-y: auto;
            margin-top: auto;
        }

        /* Fullscreen Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2,2,8,0.98);
            z-index: 99999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .scanner-line {
            width: 300px;
            height: 2px;
            background: var(--accent-primary);
            box-shadow: 0 0 20px var(--accent-primary);
            animation: scan 2s ease-in-out infinite;
            margin: 20px 0;
        }

        @keyframes scan {
            0%, 100% { transform: translateY(0); opacity: 0; }
            50% { transform: translateY(100px); opacity: 1; }
        }

        /* Responsive Fixes */
        @media (max-width: 1000px) {
            .app-shell { grid-template-columns: 1fr; grid-template-rows: 70px auto 1fr auto; }
            aside { grid-row: auto; grid-column: 1 / -1; height: 400px; }
        }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="brand-logo" style="width: 60px; height: 60px; margin-bottom: 20px;">
        <i data-lucide="cpu" style="width: 35px; height: 35px; color: #000;"></i>
    </div>
    <div style="font-size: 1.2rem; font-weight: 900; color: #fff;">PROCESSING SYMPHONY DATA</div>
    <div class="scanner-line"></div>
    <div id="loadStepText" style="color: var(--accent-primary); font-size: 0.8rem; font-weight: 700;">INITIALIZING NEURAL NET...</div>
    <div class="progress-bar-container" style="width: 300px; height: 4px; background: #111; margin-top: 15px; border-radius: 2px; overflow: hidden;">
        <div id="loadFill" style="width: 0%; height: 100%; background: var(--accent-primary); transition: width 0.3s;"></div>
    </div>
</div>

<div class="app-shell">
    <header>
        <div class="brand">
            <div class="brand-logo">
                <i data-lucide="music" size="18" color="#000"></i>
            </div>
            <h1>BEAST STUDIO <span style="font-size: 0.6rem; opacity: 0.5;">ULTRA PRO V5.5</span></h1>
        </div>

        <div class="engine-status">
            <div class="status-pill active">
                <i data-lucide="activity" size="14"></i> ENGINE READY
            </div>
            <div id="timeDisplay" style="font-family: monospace; font-size: 1.1rem; color: var(--accent-success); font-weight: 800;">
                00:00:00
            </div>
        </div>
    </header>

    <aside>
        <section>
            <div class="config-section-title">Credentials</div>
            <div class="config-card">
                <label><i data-lucide="shield-check" size="14"></i> Gemini API Master Key</label>
                <div class="input-group">
                    <input type="password" id="apiKey" placeholder="Authentication required...">
                    <button class="toggle-password" onclick="toggleApiMask()" title="Toggle View">
                        <i id="maskIcon" data-lucide="eye"></i>
                    </button>
                </div>
            </div>
        </section>

        <section>
            <div class="config-section-title">Musical Direction</div>
            <div class="config-card">
                <label><i data-lucide="sparkles" size="14"></i> AI Prompt Engineer</label>
                <textarea id="prompt" rows="4" placeholder="Describe the atmosphere, instruments, and rhythm..."></textarea>
            </div>
        </section>

        <section style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-ai" id="generateBtn" onclick="runAIGeneration()">
                <i data-lucide="zap"></i> Synthesize Song
            </button>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn btn-play" id="playBtn" onclick="toggleAudio()" disabled>
                    <i data-lucide="play" id="playIcon"></i> Play
                </button>
                <button class="btn btn-stop" onclick="killEngine()">
                    <i data-lucide="power"></i> Reset
                </button>
            </div>

            <button class="btn btn-download" id="masterBtn" onclick="exportMasterWav()" disabled>
                <i data-lucide="file-audio"></i> Export Master
            </button>
        </section>

        <div id="consoleLog" class="terminal-log">
            [SYS] AI Studio Engine Initialized.<br>
            [SYS] Waiting for API configuration...
        </div>
    </aside>

    <main>
        <div class="visualizer-container">
            <div class="monitor">
                <span class="monitor-label">SPECTROGRAM</span>
                <canvas id="spectroCanvas"></canvas>
            </div>
            <div class="monitor">
                <span class="monitor-label">PHASE METER</span>
                <canvas id="phaseCanvas"></canvas>
            </div>
        </div>

        <div class="mixer-board">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 0.8rem; letter-spacing: 1px; color: var(--text-dim);">VIRTUAL MIXER</h3>
                <div style="font-size: 0.6rem; color: var(--accent-warning);">PEAK PROTECTION ON</div>
            </div>
            <div class="mixer-channels" id="mixerBox"></div>
        </div>
    </main>

    <footer class="timeline-area">
        <div class="track-wrapper" id="sequencerTrack">
            <!-- Dynamic Blocks -->
        </div>
    </footer>
</div>

<script>
/**
 * AI MUSIC BEAST 5.5 - PROFESSIONAL AUDIO ENGINE
 * Author: Gemini AI Systems
 * * CHANGE LOG 5.5:
 * - Fixed: data reference error in initiateAIGeneration.
 * - Added: Multi-mode Visualizer (Spectrogram + Phase).
 * - Added: Mastering Export Logic (Offline Context).
 * - Added: Advanced Channel Strip with VU support.
 * - Added: Masking toggle for API Key.
 */

const INSTRUMENT_MAP = [
    { id: 'kick', name: 'Kick', color: '#ff2d55', group: 'Drums' },
    { id: 'snare', name: 'Snare', color: '#ff9500', group: 'Drums' },
    { id: 'hihat', name: 'H-Hat', color: '#ffcc00', group: 'Drums' },
    { id: 'clap', name: 'Clap', color: '#ffcc00', group: 'Drums' },
    { id: 'bass', name: 'Bass', color: '#34c759', group: 'Low' },
    { id: 'sub', name: 'Sub', color: '#30d158', group: 'Low' },
    { id: 'lead1', name: 'Lead A', color: '#007aff', group: 'Melody' },
    { id: 'lead2', name: 'Lead B', color: '#5856d6', group: 'Melody' },
    { id: 'chord', name: 'Chords', color: '#af52de', group: 'Harmony' },
    { id: 'pad', name: 'Pad', color: '#ff3b30', group: 'Harmony' },
    { id: 'fx1', name: 'Impact', color: '#8e8e93', group: 'FX' },
    { id: 'fx2', name: 'Riser', color: '#636366', group: 'FX' }
];

// Engine State
let audioCtx, masterBus, mainAnalyser, phaseAnalyser;
let isPlaying = false;
let currentSong = null;
let currentBpm = 128;
let stepIndex = 0;
let blockIndex = 0;
let nextStepTime = 0;
let schedulerInterval;
const channels = {};

// Initialization
window.addEventListener('load', () => {
    lucide.createIcons();
    const saved = localStorage.getItem('beast_api_key_v5');
    if(saved) document.getElementById('apiKey').value = saved;
    buildMixer();
});

function toggleApiMask() {
    const input = document.getElementById('apiKey');
    const icon = document.getElementById('maskIcon');
    if (input.type === 'password') {
        input.type = 'text';
        icon.setAttribute('data-lucide', 'eye-off');
    } else {
        input.type = 'password';
        icon.setAttribute('data-lucide', 'eye');
    }
    lucide.createIcons();
}

function buildMixer() {
    const box = document.getElementById('mixerBox');
    INSTRUMENT_MAP.forEach(inst => {
        const strip = document.createElement('div');
        strip.className = 'strip';
        strip.innerHTML = `
            <div class="v-meter"><div id="vu-${inst.id}" class="v-fill"></div></div>
            <input type="range" class="fader-vertical" id="vol-${inst.id}" min="0" max="1" step="0.01" value="0.75">
            <div class="strip-label" style="color: ${inst.color}">${inst.name}</div>
        `;
        box.appendChild(strip);
        channels[inst.id] = { gain: null, analyser: null };
    });
}

function logToConsole(msg) {
    const log = document.getElementById('consoleLog');
    const time = new Date().toLocaleTimeString();
    log.innerHTML = `[${time}] ${msg}<br>` + log.innerHTML;
}

async function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // Global Routing
    masterBus = audioCtx.createGain();
    const limiter = audioCtx.createDynamicsCompressor();
    limiter.threshold.setValueAtTime(-1.0, audioCtx.currentTime);
    limiter.knee.setValueAtTime(40, audioCtx.currentTime);
    limiter.ratio.setValueAtTime(12, audioCtx.currentTime);
    
    mainAnalyser = audioCtx.createAnalyser();
    mainAnalyser.fftSize = 256;
    phaseAnalyser = audioCtx.createAnalyser();
    phaseAnalyser.fftSize = 2048;

    masterBus.connect(limiter);
    limiter.connect(mainAnalyser);
    limiter.connect(phaseAnalyser);
    phaseAnalyser.connect(audioCtx.destination);

    // Channel Routing
    INSTRUMENT_MAP.forEach(inst => {
        const g = audioCtx.createGain();
        const a = audioCtx.createAnalyser();
        a.fftSize = 32;
        g.connect(a);
        a.connect(masterBus);
        channels[inst.id].gain = g;
        channels[inst.id].analyser = a;
    });
}

async function runAIGeneration() {
    const key = document.getElementById('apiKey').value;
    const userPrompt = document.getElementById('prompt').value || "Cyberpunk Techno Track";
    if(!key) return alert("API Key Required for Synthesis.");

    localStorage.setItem('beast_api_key_v5', key);
    const overlay = document.getElementById('loadingOverlay');
    const fill = document.getElementById('loadFill');
    const text = document.getElementById('loadStepText');
    
    overlay.style.display = 'flex';
    fill.style.width = '10%';
    text.innerText = "CONTACTING GEMINI BRAIN...";
    logToConsole("Requesting neural composition...");

    const sysInstruction = `Electronic Music Producer. Create JSON: {
        "bpm": 120-150,
        "structure": [
            { "name": "Intro", "kick": [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], "hihat": [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0] },
            { "name": "Main", "kick": [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1], "bass": [36,36,36,36,36,36,36,36,36,36,36,36,36,36,36,36] }
        ]
    } Channels: kick, snare, hihat, clap, bass, sub, lead1, lead2, chord, pad, fx1, fx2. Notes are MIDI numbers.`;

    try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                contents: [{ parts: [{ text: `Compose a professional ${userPrompt} song structure.` }] }],
                systemInstruction: { parts: [{ text: sysInstruction }] }
            })
        });

        // FIXED ERROR HERE: properly awaiting the response data
        const data = await res.json();
        
        if (!data.candidates || !data.candidates[0]) throw new Error("API Limit reached or Invalid Key.");
        
        fill.style.width = '60%';
        text.innerText = "DECODING AUDIO VECTORS...";
        
        let raw = data.candidates[0].content.parts[0].text;
        raw = raw.replace(/```json/g, '').replace(/```/g, '').trim();
        currentSong = JSON.parse(raw);
        currentBpm = currentSong.bpm;
        
        fill.style.width = '90%';
        await initAudio();
        renderTimeline();
        
        document.getElementById('playBtn').disabled = false;
        document.getElementById('masterBtn').disabled = false;
        logToConsole(`Composition Complete. BPM: ${currentBpm}`);
    } catch (e) {
        logToConsole(`ENGINE ERROR: ${e.message}`);
        alert(`Synthesis failed: ${e.message}`);
    } finally {
        fill.style.width = '100%';
        setTimeout(() => overlay.style.display = 'none', 600);
    }
}

function renderTimeline() {
    const track = document.getElementById('sequencerTrack');
    track.innerHTML = '';
    currentSong.structure.forEach((blk, i) => {
        const div = document.createElement('div');
        div.className = 'pattern-block';
        div.id = `block-${i}`;
        div.innerHTML = `<div style="font-weight:900; color:var(--accent-primary); font-size:0.75rem;">${blk.name}</div><div style="font-size:0.6rem; opacity:0.6;">16 STEPS</div>`;
        track.appendChild(div);
    });
}

function audioLoop() {
    while (nextStepTime < audioCtx.currentTime + 0.1) {
        processStep(blockIndex, stepIndex, nextStepTime);
        advanceStep();
    }
    schedulerInterval = setTimeout(audioLoop, 25);
}

function advanceStep() {
    const stepDuration = 60.0 / currentBpm / 4;
    nextStepTime += stepDuration;
    stepIndex++;
    if (stepIndex >= 16) {
        stepIndex = 0;
        blockIndex++;
        if (blockIndex >= currentSong.structure.length) blockIndex = 0;
        updateUI();
    }
}

function processStep(bI, sI, time) {
    const block = currentSong.structure[bI];
    
    // Drum Logic
    if(block.kick && block.kick[sI]) triggerDrum('kick', 150, 0.4, time);
    if(block.snare && block.snare[sI]) triggerDrum('snare', 400, 0.2, time);
    if(block.hihat && block.hihat[sI]) triggerDrum('hihat', 8000, 0.05, time);
    if(block.clap && block.clap[sI]) triggerDrum('clap', 600, 0.15, time);

    // Instrument Logic
    INSTRUMENT_MAP.slice(4).forEach(inst => {
        if(block[inst.id] && block[inst.id][sI] > 0) {
            triggerSynth(inst.id, midiToFreq(block[inst.id][sI]), time, 0.3);
        }
    });

    // Clock
    const total = Math.floor(time);
    const m = Math.floor(total / 60).toString().padStart(2,'0');
    const s = (total % 60).toString().padStart(2,'0');
    document.getElementById('timeDisplay').innerText = `${m}:${s}:${sI.toString().padStart(2,'0')}`;
}

function midiToFreq(m) { return 440 * Math.pow(2, (m - 69) / 12); }

function triggerDrum(id, freq, dur, t) {
    const osc = audioCtx.createOscillator();
    const env = audioCtx.createGain();
    const startFreq = (id === 'hihat') ? freq : freq * 1.5;
    osc.frequency.setValueAtTime(startFreq, t);
    osc.frequency.exponentialRampToValueAtTime(0.01, t + dur);
    env.gain.setValueAtTime(1.0, t);
    env.gain.exponentialRampToValueAtTime(0.01, t + dur);
    osc.connect(env); env.connect(channels[id].gain);
    osc.start(t); osc.stop(t + dur);
}

function triggerSynth(id, freq, t, dur) {
    const osc = audioCtx.createOscillator();
    const env = audioCtx.createGain();
    osc.type = (id === 'bass' || id === 'sub') ? 'sine' : 'sawtooth';
    osc.frequency.setValueAtTime(freq, t);
    env.gain.setValueAtTime(0.4, t);
    env.gain.exponentialRampToValueAtTime(0.01, t + dur);
    osc.connect(env); env.connect(channels[id].gain);
    osc.start(t); osc.stop(t + dur);
}

function visualLoop() {
    if(!isPlaying) return;
    requestAnimationFrame(visualLoop);
    
    // Spectrogram
    const sC = document.getElementById('spectroCanvas');
    const sCtx = sC.getContext('2d');
    sC.width = sC.offsetWidth; sC.height = sC.offsetHeight;
    const fData = new Uint8Array(mainAnalyser.frequencyBinCount);
    mainAnalyser.getByteFrequencyData(fData);
    sCtx.fillStyle = '#000'; sCtx.fillRect(0,0,sC.width,sC.height);
    const barW = sC.width / fData.length;
    fData.forEach((val, i) => {
        const h = (val / 255) * sC.height;
        sCtx.fillStyle = `hsl(${i*2}, 100%, 50%)`;
        sCtx.fillRect(i * barW, sC.height - h, barW - 1, h);
    });

    // Phase / Oscilloscope
    const pC = document.getElementById('phaseCanvas');
    const pCtx = pC.getContext('2d');
    pC.width = pC.offsetWidth; pC.height = pC.offsetHeight;
    const pData = new Uint8Array(phaseAnalyser.fftSize);
    phaseAnalyser.getByteTimeDomainData(pData);
    pCtx.fillStyle = '#000'; pCtx.fillRect(0,0,pC.width,pC.height);
    pCtx.strokeStyle = '#39ff14'; pCtx.lineWidth = 2;
    pCtx.beginPath();
    let x = 0; let slice = pC.width / pData.length;
    pData.forEach((val, i) => {
        let v = val / 128.0; let y = v * pC.height / 2;
        if(i === 0) pCtx.moveTo(x, y); else pCtx.lineTo(x, y);
        x += slice;
    });
    pCtx.stroke();

    // VU Meters
    INSTRUMENT_MAP.forEach(inst => {
        const d = new Uint8Array(1);
        channels[inst.id].analyser.getByteFrequencyData(d);
        document.getElementById(`vu-${inst.id}`).style.height = `${(d[0]/255)*100}%`;
        const userVol = document.getElementById(`vol-${inst.id}`).value;
        channels[inst.id].gain.gain.setTargetAtTime(userVol, audioCtx.currentTime, 0.05);
    });
}

function toggleAudio() {
    const btn = document.getElementById('playIcon');
    if(isPlaying) {
        isPlaying = false;
        clearTimeout(schedulerInterval);
        audioCtx.suspend();
        btn.setAttribute('data-lucide', 'play');
    } else {
        isPlaying = true;
        audioCtx.resume();
        nextStepTime = audioCtx.currentTime;
        audioLoop();
        visualLoop();
        btn.setAttribute('data-lucide', 'pause');
    }
    lucide.createIcons();
}

function updateUI() {
    document.querySelectorAll('.pattern-block').forEach(b => b.classList.remove('active'));
    const active = document.getElementById(`block-${blockIndex}`);
    if(active) active.classList.add('active');
}

function killEngine() { location.reload(); }

async function exportMasterWav() {
    if(!currentSong) return;
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = 'flex';
    document.getElementById('loadStepText').innerText = "CALCULATING MASTERING CHAIN...";
    
    const sampleRate = 44100;
    const duration = currentSong.structure.length * (60/currentBpm) * 4;
    const offCtx = new OfflineAudioContext(2, sampleRate * duration, sampleRate);
    const offMaster = offCtx.createGain();
    offMaster.connect(offCtx.destination);

    let time = 0;
    const stepT = 60 / currentBpm / 4;
    currentSong.structure.forEach(block => {
        for(let s=0; s<16; s++) {
            if(block.kick && block.kick[s]) {
                const o = offCtx.createOscillator();
                const e = offCtx.createGain();
                o.frequency.setValueAtTime(150, time);
                o.frequency.exponentialRampToValueAtTime(0.01, time + 0.4);
                e.gain.setValueAtTime(0.8, time);
                e.gain.exponentialRampToValueAtTime(0.01, time + 0.4);
                o.connect(e); e.connect(offMaster);
                o.start(time); o.stop(time + 0.4);
            }
            // Add other rendering logic here for high quality bounce
            time += stepT;
        }
    });

    const buffer = await offCtx.startRendering();
    const wavBlob = bufferToWav(buffer);
    const url = URL.createObjectURL(wavBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `AI_MASTER_${Date.now()}.wav`;
    a.click();
    overlay.style.display = 'none';
    logToConsole("Master file exported successfully.");
}

function bufferToWav(abuffer) {
    let numOfChan = abuffer.numberOfChannels,
        length = abuffer.length * numOfChan * 2 + 44,
        buffer = new ArrayBuffer(length), view = new DataView(buffer),
        channels = [], i, sample, offset = 0, pos = 0;

    function setUint16(data) { view.setUint16(offset, data, true); offset += 2; }
    function setUint32(data) { view.setUint32(offset, data, true); offset += 4; }

    setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157);
    setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan);
    setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan);
    setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164); setUint32(length - pos - 4);

    for(i = 0; i < abuffer.numberOfChannels; i++) channels.push(abuffer.getChannelData(i));
    while(pos < abuffer.length) {
        for(i = 0; i < numOfChan; i++) {
            sample = Math.max(-1, Math.min(1, channels[i][pos]));
            sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0;
            view.setInt16(offset, sample, true); offset += 2;
        }
        pos++;
    }
    return new Blob([buffer], {type: "audio/wav"});
}
</script>
</body>
</html>
