<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI MUSIC BEAST - אולפן הפקה אולטרה פרו V6.0</title>
    <!-- טעינת ספריות חיצוניות לעיצוב ואייקונים -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /**
         * מערכת עיצוב מתקדמת - BEAST STUDIO 6.0
         * מותאם אישית למפיקי מוזיקה מקצועיים
         */
        :root {
            --bg-base: #020205;
            --bg-surface: #0a0a14;
            --bg-element: #121222;
            --accent-primary: #00f2ff;
            --accent-secondary: #7000ff;
            --accent-success: #39ff14;
            --accent-danger: #ff0055;
            --accent-warning: #ffcc00;
            --text-main: #f0f0f5;
            --text-dim: #9494a5;
            --border: #1e1e35;
            --shadow-neon: 0 0 25px rgba(0, 242, 255, 0.15);
            --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { 
            box-sizing: border-box; 
            outline: none; 
            transition: all var(--transition); 
            user-select: none;
        }
        
        body {
            background: var(--bg-base);
            color: var(--text-main);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* מבנה האפליקציה */
        .app-shell {
            display: grid;
            grid-template-columns: 380px 1fr;
            grid-template-rows: 70px 1fr 220px;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at 50% 50%, #0a0a1f 0%, #020205 100%);
        }

        /* סרגל עליון */
        header {
            grid-column: 1 / -1;
            background: rgba(10, 10, 20, 0.9);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 35px;
            z-index: 1000;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-logo {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px var(--accent-primary);
        }

        .brand h1 {
            font-size: 1.3rem;
            letter-spacing: 1px;
            margin: 0;
            font-weight: 900;
            color: #fff;
        }

        .engine-status {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-pill {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-pill.active { border-color: var(--accent-success); color: var(--accent-success); }

        /* פאנל שליטה צדדי */
        aside {
            grid-row: 2 / -1;
            background: var(--bg-surface);
            border-left: 1px solid var(--border);
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .config-card {
            background: var(--bg-element);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px;
        }

        .config-card label {
            display: block;
            font-size: 0.8rem;
            color: var(--accent-primary);
            margin-bottom: 12px;
            font-weight: 700;
        }

        .input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        input, textarea {
            width: 100%;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: #fff;
            padding: 12px 15px;
            font-size: 0.9rem;
        }

        .btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
        }

        .btn-ai { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: #000; }
        .btn-play { background: var(--accent-success); color: #000; }
        .btn-stop { background: var(--accent-danger); color: #fff; }
        .btn-master { background: #fff; color: #000; }

        /* אזור עבודה ראשי */
        main {
            grid-row: 2 / 3;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .visualizer-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 300px;
        }

        .monitor {
            background: #000;
            border-radius: 20px;
            border: 1px solid var(--border);
            position: relative;
        }

        .monitor-label {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 0.6rem;
            color: var(--accent-primary);
            background: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* מיקסר */
        .mixer-board {
            background: var(--bg-element);
            border-radius: 24px;
            padding: 25px;
            border: 1px solid var(--border);
        }

        .mixer-channels {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .strip {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0,0,0,0.2);
            padding: 15px 5px;
            border-radius: 14px;
            border: 1px solid var(--border);
        }

        .v-meter {
            width: 10px;
            height: 120px;
            background: #080808;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        .v-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top, #39ff14, #ffcc00, #ff0055);
        }

        .fader {
            writing-mode: bt-lr; 
            -webkit-appearance: slider-vertical;
            width: 20px;
            height: 80px;
            margin: 10px 0;
        }

        /* ציר זמן */
        .timeline-area {
            grid-column: 2 / 3;
            grid-row: 3 / 4;
            background: var(--bg-surface);
            border-top: 1px solid var(--border);
            padding: 20px;
            overflow-x: auto;
            display: flex;
            align-items: center;
        }

        .pattern-block {
            min-width: 180px;
            height: 80px;
            background: var(--bg-element);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin: 0 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 15px;
            position: relative;
        }

        .pattern-block.active {
            border-color: var(--accent-primary);
            background: rgba(0, 242, 255, 0.05);
        }

        /* לוגר מערכת */
        .terminal-log {
            background: #000;
            border: 1px solid var(--border);
            border-radius: 12px;
            height: 120px;
            padding: 12px;
            font-family: monospace;
            font-size: 0.75rem;
            color: #00ffaa;
            overflow-y: auto;
        }

        /* מסך טעינה */
        #loadingOverlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2,2,8,0.98);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .loader-bar {
            width: 300px;
            height: 4px;
            background: #111;
            margin-top: 20px;
            border-radius: 2px;
            overflow: hidden;
        }

        .loader-fill {
            width: 0%;
            height: 100%;
            background: var(--accent-primary);
            transition: width 0.4s;
        }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="brand-logo" style="width: 70px; height: 70px; margin-bottom: 25px;">
        <i data-lucide="cpu" style="width: 40px; height: 40px; color: #000;"></i>
    </div>
    <div style="font-size: 1.1rem; font-weight: 800;" id="loadText">מעבד קומפוזיציה בינה מלאכותית...</div>
    <div class="loader-bar"><div class="loader-fill" id="loadFill"></div></div>
</div>

<div class="app-shell">
    <header>
        <div class="brand">
            <div class="brand-logo"><i data-lucide="music" size="18" color="#000"></i></div>
            <h1>BEAST STUDIO <span style="font-size: 0.7rem; opacity: 0.5;">ULTRA 6.0</span></h1>
        </div>
        <div class="engine-status">
            <div class="status-pill active"><i data-lucide="zap" size="14"></i> מנוע מופעל</div>
            <div id="clockDisplay" style="font-family: monospace; font-size: 1.2rem; color: var(--accent-success);">00:00:00</div>
        </div>
    </header>

    <aside>
        <section class="config-card">
            <label>גישה למערכת (API Key)</label>
            <div class="input-group">
                <input type="password" id="apiKey" placeholder="הכנס מפתח Gemini...">
            </div>
        </section>

        <section class="config-card">
            <label>הנחיה מוזיקלית (Prompt)</label>
            <textarea id="promptInput" rows="4" placeholder="תאר את השיר: סגנון, כלים, אווירה..."></textarea>
        </section>

        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-ai" id="genBtn" onclick="generateTrack()"><i data-lucide="sparkles"></i> סנתז שיר</button>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn btn-play" id="playBtn" onclick="togglePlayback()" disabled><i data-lucide="play" id="playIcon"></i> נגן</button>
                <button class="btn btn-stop" onclick="location.reload()"><i data-lucide="refresh-cw"></i> איפוס</button>
            </div>
            <button class="btn btn-master" id="exportBtn" onclick="exportMaster()" disabled><i data-lucide="download"></i> ייצוא מאסטר</button>
        </div>

        <div id="consoleLog" class="terminal-log">
            [SYS] המערכת מוכנה לעבודה.<br>
            [SYS] ממתין להזנת מפתח API...
        </div>
    </aside>

    <main>
        <div class="visualizer-container">
            <div class="monitor">
                <span class="monitor-label">תדרים (Spectrum)</span>
                <canvas id="specCanvas"></canvas>
            </div>
            <div class="monitor">
                <span class="monitor-label">פאזה (Waveform)</span>
                <canvas id="waveCanvas"></canvas>
            </div>
        </div>

        <div class="mixer-board">
            <h3 style="margin:0 0 15px 0; font-size: 0.8rem; opacity: 0.6;">מיקסר ערוצים</h3>
            <div class="mixer-channels" id="mixerBox"></div>
        </div>
    </main>

    <footer class="timeline-area" id="timeline">
        <!-- בלוקים דינמיים של השיר -->
    </footer>
</div>

<script>
/**
 * BEAST STUDIO 6.0 - ליבת האודיו וניהול ה-API
 * מנוע הסנתוז והייצוא החדש
 */

const INST_CONFIG = [
    { id: 'kick', name: 'KICK', color: '#ff0055' },
    { id: 'snare', name: 'SNARE', color: '#ffcc00' },
    { id: 'hihat', name: 'HI-HAT', color: '#00f2ff' },
    { id: 'bass', name: 'BASS', color: '#39ff14' },
    { id: 'lead', name: 'LEAD', color: '#7000ff' },
    { id: 'pad', name: 'PAD', color: '#ff9500' }
];

let audioCtx, masterBus, analyser, waveformAnalyser;
let isPlaying = false;
let currentSongData = null;
let currentBpm = 120;
let step = 0;
let block = 0;
let nextTime = 0;
let timerId;
const channelGains = {};

// אתחול הממשק
window.onload = () => {
    lucide.createIcons();
    const box = document.getElementById('mixerBox');
    INST_CONFIG.forEach(inst => {
        const strip = document.createElement('div');
        strip.className = 'strip';
        strip.innerHTML = `
            <div class="v-meter"><div id="vu-${inst.id}" class="v-fill"></div></div>
            <input type="range" class="fader" id="vol-${inst.id}" min="0" max="1" step="0.01" value="0.7">
            <div style="font-size:0.6rem; font-weight:900; color:${inst.color}">${inst.name}</div>
        `;
        box.appendChild(strip);
    });
};

function addLog(msg) {
    const log = document.getElementById('consoleLog');
    log.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>${log.innerHTML}`;
}

async function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterBus = audioCtx.createGain();
    
    // קומפרסור הגנה
    const limiter = audioCtx.createDynamicsCompressor();
    limiter.threshold.setValueAtTime(-1.0, audioCtx.currentTime);
    limiter.connect(audioCtx.destination);
    masterBus.connect(limiter);

    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    waveformAnalyser = audioCtx.createAnalyser();
    waveformAnalyser.fftSize = 2048;
    masterBus.connect(analyser);
    masterBus.connect(waveformAnalyser);

    INST_CONFIG.forEach(inst => {
        const g = audioCtx.createGain();
        g.connect(masterBus);
        channelGains[inst.id] = g;
    });
}

async function generateTrack() {
    const key = document.getElementById('apiKey').value;
    const prompt = document.getElementById('promptInput').value || "Techno Track";
    if(!key) return alert("נא להזין מפתח API");

    const overlay = document.getElementById('loadingOverlay');
    const fill = document.getElementById('loadFill');
    overlay.style.display = 'flex';
    fill.style.width = '20%';

    const sysPrompt = `You are a music AI. Output ONLY JSON. 
    Format: {"bpm": 128, "structure": [{"name": "Intro", "kick": [1,0,0,0,1,0,0,0], "bass": [36,0,36,0,36,0,36,0]}]}. 
    Instruments: kick, snare, hihat, bass, lead, pad. Steps: 16 per block. Notes in MIDI.`;

    try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                contents: [{ parts: [{ text: `Create a professional ${prompt} in JSON.` }] }],
                systemInstruction: { parts: [{ text: sysPrompt }] }
            })
        });

        const jsonRes = await res.json();
        fill.style.width = '70%';
        
        let rawJson = jsonRes.candidates[0].content.parts[0].text;
        rawJson = rawJson.replace(/```json/g, '').replace(/```/g, '').trim();
        currentSongData = JSON.parse(rawJson);
        currentBpm = currentSongData.bpm;

        await initAudio();
        renderTimeline();
        document.getElementById('playBtn').disabled = false;
        document.getElementById('exportBtn').disabled = false;
        addLog(`השיר נוצר בהצלחה! BPM: ${currentBpm}`);
    } catch (e) {
        addLog(`שגיאת API: ${e.message}`);
        alert("תקלה בתקשורת עם ה-AI");
    } finally {
        fill.style.width = '100%';
        setTimeout(() => overlay.style.display = 'none', 500);
    }
}

function renderTimeline() {
    const tl = document.getElementById('timeline');
    tl.innerHTML = '';
    currentSongData.structure.forEach((b, i) => {
        const div = document.createElement('div');
        div.className = 'pattern-block';
        div.id = `blk-${i}`;
        div.innerHTML = `<span style="color:var(--accent-primary); font-weight:800">${b.name}</span><br><small>16 Steps</small>`;
        tl.appendChild(div);
    });
}

function playLoop() {
    while (nextTime < audioCtx.currentTime + 0.1) {
        scheduleStep(block, step, nextTime);
        const stepLen = 60 / currentBpm / 4;
        nextTime += stepLen;
        step++;
        if (step >= 16) {
            step = 0;
            block++;
            if (block >= currentSongData.structure.length) block = 0;
            updateUI();
        }
    }
    timerId = setTimeout(playLoop, 25);
}

function scheduleStep(bIdx, sIdx, time) {
    const data = currentSongData.structure[bIdx];
    
    // Drum Synthesis
    if(data.kick && data.kick[sIdx]) triggerDrum('kick', 120, 0.4, time, audioCtx, channelGains['kick']);
    if(data.snare && data.snare[sIdx]) triggerDrum('snare', 400, 0.2, time, audioCtx, channelGains['snare']);
    if(data.hihat && data.hihat[sIdx]) triggerDrum('hihat', 8000, 0.05, time, audioCtx, channelGains['hihat']);

    // Tone Synthesis
    if(data.bass && data.bass[sIdx]) triggerSynth('bass', m2f(data.bass[sIdx]), 0.4, time, audioCtx, channelGains['bass']);
    if(data.lead && data.lead[sIdx]) triggerSynth('lead', m2f(data.lead[sIdx]), 0.3, time, audioCtx, channelGains['lead']);

    // Clock Display
    const totalSec = Math.floor(time);
    const m = Math.floor(totalSec/60).toString().padStart(2,'0');
    const s = (totalSec%60).toString().padStart(2,'0');
    document.getElementById('clockDisplay').innerText = `${m}:${s}:${sIdx.toString().padStart(2,'0')}`;
}

function m2f(m) { return 440 * Math.pow(2, (m - 69) / 12); }

function triggerDrum(type, freq, dur, t, ctx, dest) {
    const osc = ctx.createOscillator();
    const env = ctx.createGain();
    osc.frequency.setValueAtTime(freq, t);
    osc.frequency.exponentialRampToValueAtTime(0.01, t + dur);
    env.gain.setValueAtTime(1.0, t);
    env.gain.exponentialRampToValueAtTime(0.01, t + dur);
    osc.connect(env); env.connect(dest);
    osc.start(t); osc.stop(t + dur);
}

function triggerSynth(type, freq, dur, t, ctx, dest) {
    const osc = ctx.createOscillator();
    const env = ctx.createGain();
    osc.type = (type === 'bass') ? 'triangle' : 'sawtooth';
    osc.frequency.setValueAtTime(freq, t);
    env.gain.setValueAtTime(0.3, t);
    env.gain.exponentialRampToValueAtTime(0.01, t + dur);
    osc.connect(env); env.connect(dest);
    osc.start(t); osc.stop(t + dur);
}

function drawVisuals() {
    if(!isPlaying) return;
    requestAnimationFrame(drawVisuals);

    // Spectrum
    const sc = document.getElementById('specCanvas');
    const sctx = sc.getContext('2d');
    sc.width = sc.offsetWidth; sc.height = sc.offsetHeight;
    const fData = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(fData);
    sctx.fillStyle = '#000'; sctx.fillRect(0,0,sc.width,sc.height);
    fData.forEach((v, i) => {
        const barH = (v/255) * sc.height;
        sctx.fillStyle = `hsl(${i*2}, 100%, 50%)`;
        sctx.fillRect(i * (sc.width/fData.length), sc.height - barH, 2, barH);
    });

    // VU Meters
    INST_CONFIG.forEach(inst => {
        const vol = document.getElementById(`vol-${inst.id}`).value;
        channelGains[inst.id].gain.setTargetAtTime(vol, audioCtx.currentTime, 0.05);
        document.getElementById(`vu-${inst.id}`).style.height = `${vol * 100}%`;
    });
}

function togglePlayback() {
    const icon = document.getElementById('playIcon');
    if(isPlaying) {
        isPlaying = false;
        audioCtx.suspend();
        clearTimeout(timerId);
        icon.setAttribute('data-lucide', 'play');
    } else {
        isPlaying = true;
        audioCtx.resume();
        nextTime = audioCtx.currentTime;
        playLoop();
        drawVisuals();
        icon.setAttribute('data-lucide', 'pause');
    }
    lucide.createIcons();
}

function updateUI() {
    document.querySelectorAll('.pattern-block').forEach(el => el.classList.remove('active'));
    document.getElementById(`blk-${block}`).classList.add('active');
}

/**
 * פונקציות ייצוא מאסטר מתוקנות לחלוטין
 */
async function exportMaster() {
    if(!currentSongData) return;
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = 'flex';
    document.getElementById('loadText').innerText = "מבצע רינדור מאסטר ל-WAV...";

    const sampleRate = 44100;
    const duration = currentSongData.structure.length * 4 * (60 / currentBpm);
    const offCtx = new OfflineAudioContext(2, sampleRate * duration, sampleRate);
    const offMaster = offCtx.createGain();
    offMaster.connect(offCtx.destination);

    let t = 0;
    const sLen = 60 / currentBpm / 4;

    currentSongData.structure.forEach(block => {
        for(let s=0; s<16; s++) {
            if(block.kick && block.kick[s]) triggerDrum('kick', 120, 0.4, t, offCtx, offMaster);
            if(block.snare && block.snare[s]) triggerDrum('snare', 400, 0.2, t, offCtx, offMaster);
            if(block.hihat && block.hihat[s]) triggerDrum('hihat', 8000, 0.05, t, offCtx, offMaster);
            if(block.bass && block.bass[s]) triggerSynth('bass', m2f(block.bass[s]), 0.4, t, offCtx, offMaster);
            if(block.lead && block.lead[s]) triggerSynth('lead', m2f(block.lead[s]), 0.3, t, offCtx, offMaster);
            t += sLen;
        }
    });

    try {
        const renderedBuffer = await offCtx.startRendering();
        const wavBlob = createWavBlob(renderedBuffer);
        const url = URL.createObjectURL(wavBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `BEAST_MASTER_${Date.now()}.wav`;
        a.click();
        addLog("הקובץ יוצא בהצלחה!");
    } catch(err) {
        addLog("שגיאה בייצוא: " + err.message);
    } finally {
        overlay.style.display = 'none';
    }
}

// פונקציית העזר לכתיבת WAV - מוגדרת בצורה גלובלית למניעת שגיאת scope
function createWavBlob(audioBuffer) {
    const numChannels = audioBuffer.numberOfChannels;
    const sampleRate = audioBuffer.sampleRate;
    const format = 1; // PCM
    const bitDepth = 16;
    
    const bytesPerSample = bitDepth / 8;
    const blockAlign = numChannels * bytesPerSample;
    
    const buffer = new ArrayBuffer(44 + audioBuffer.length * blockAlign);
    const view = new DataView(buffer);
    
    // פונקציות כתיבה מקומיות
    const writeString = (offset, string) => {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    };

    writeString(0, 'RIFF');
    view.setUint32(4, 36 + audioBuffer.length * blockAlign, true);
    writeString(8, 'WAVE');
    writeString(12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, format, true);
    view.setUint16(22, numChannels, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * blockAlign, true);
    view.setUint16(32, blockAlign, true);
    view.setUint16(34, bitDepth, true);
    writeString(36, 'data');
    view.setUint32(40, audioBuffer.length * blockAlign, true);

    const offset = 44;
    const channelData = [];
    for(let i=0; i<numChannels; i++) channelData.push(audioBuffer.getChannelData(i));
    
    let index = 0;
    for(let i=0; i<audioBuffer.length; i++) {
        for(let channel=0; channel<numChannels; channel++) {
            let sample = channelData[channel][i];
            sample = Math.max(-1, Math.min(1, sample));
            sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
            view.setInt16(offset + index, sample, true);
            index += 2;
        }
    }
    
    return new Blob([view], { type: 'audio/wav' });
}
</script>
</body>
</html>
