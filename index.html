<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI MUSIC BEAST - אולטרה סטודיו פרו V5.8</title>
    <!-- ספריות עזר וסמלים -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /**
         * מערכת עיצוב סטודיו מוזיקה AI
         * גרסה: 5.8 מקצועית
         */
        :root {
            --bg-base: #020205;
            --bg-surface: #0a0a14;
            --bg-element: #121222;
            --accent-primary: #00f2ff;
            --accent-secondary: #7000ff;
            --accent-success: #39ff14;
            --accent-danger: #ff0055;
            --accent-warning: #ffcc00;
            --text-main: #f0f0f5;
            --text-dim: #9494a5;
            --border: #1e1e35;
            --shadow-neon: 0 0 25px rgba(0, 242, 255, 0.15);
        }

        * { 
            box-sizing: border-box; 
            outline: none; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            user-select: none;
        }
        
        body {
            background: var(--bg-base);
            color: var(--text-main);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ארכיטקטורת פריסה */
        .app-shell {
            display: grid;
            grid-template-columns: 380px 1fr;
            grid-template-rows: 70px 1fr 220px;
            width: 100vw;
            height: 100vh;
        }

        /* סרגל עליון */
        header {
            grid-column: 1 / -1;
            background: rgba(10, 10, 20, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
        }

        .brand { display: flex; align-items: center; gap: 15px; }
        .brand h1 {
            font-size: 1.4rem;
            letter-spacing: 1px;
            background: linear-gradient(90deg, #fff, var(--accent-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            font-weight: 900;
        }

        .engine-status { display: flex; align-items: center; gap: 20px; }
        #timeDisplay { font-family: monospace; font-size: 1.2rem; color: var(--accent-success); text-shadow: 0 0 10px rgba(57, 255, 20, 0.3); }

        /* פאנל בקשה והגדרות */
        aside {
            grid-row: 2 / -1;
            background: var(--bg-surface);
            border-left: 1px solid var(--border);
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .config-card {
            background: var(--bg-element);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px;
        }

        .config-card label {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.85rem; color: var(--accent-primary);
            margin-bottom: 12px; font-weight: 700;
        }

        .input-group { position: relative; display: flex; align-items: center; }
        input, textarea, select {
            width: 100%; background: #000; border: 1px solid var(--border);
            border-radius: 10px; color: #fff; padding: 12px; font-size: 0.9rem;
        }

        .toggle-btn {
            position: absolute; left: 10px; background: none; border: none;
            color: var(--text-dim); cursor: pointer; display: flex; align-items: center;
        }

        /* כפתורי פעולה */
        .btn {
            padding: 16px; border: none; border-radius: 12px; font-weight: 800;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            gap: 10px; text-transform: uppercase; font-size: 0.85rem;
        }

        .btn-ai { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: #000; }
        .btn-play { background: var(--accent-success); color: #000; }
        .btn-stop { background: var(--accent-danger); color: #fff; }
        .btn-download { background: #fff; color: #000; }
        
        .btn:disabled { opacity: 0.2; cursor: not-allowed; filter: grayscale(1); }

        /* אזור העבודה המרכזי */
        main {
            grid-row: 2 / 3;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .visual-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 300px;
        }

        .monitor {
            background: #000; border-radius: 20px; border: 1px solid var(--border);
            position: relative; overflow: hidden;
        }

        .monitor-label {
            position: absolute; top: 15px; right: 15px; font-size: 0.65rem;
            color: var(--accent-primary); background: rgba(0,0,0,0.7);
            padding: 4px 10px; border-radius: 4px; z-index: 10;
        }

        canvas { width: 100%; height: 100%; display: block; }

        /* מיקסר */
        .mixer {
            background: var(--bg-element); border-radius: 24px; padding: 25px;
            border: 1px solid var(--border);
        }

        .mixer-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            gap: 15px; margin-top: 15px;
        }

        .channel-strip {
            display: flex; flex-direction: column; align-items: center;
            background: rgba(0,0,0,0.2); padding: 15px 5px; border-radius: 14px;
            border: 1px solid var(--border);
        }

        .vu-container {
            width: 8px; height: 120px; background: #080808; border-radius: 4px;
            position: relative; overflow: hidden;
        }

        .vu-bar {
            position: absolute; bottom: 0; width: 100%; height: 0%;
            background: linear-gradient(to top, #00ff00, #ffff00, #ff0000);
        }

        .fader {
            writing-mode: bt-lr; -webkit-appearance: slider-vertical;
            width: 20px; height: 80px; margin: 10px 0;
        }

        /* ציר זמן */
        .timeline {
            grid-column: 2 / 3; grid-row: 3 / 4; background: var(--bg-surface);
            border-top: 1px solid var(--border); padding: 20px; overflow-x: auto;
        }

        .track {
            display: flex; gap: 12px; padding: 10px; background: #05050a;
            border-radius: 16px; border: 1px solid var(--border); min-width: 100%;
        }

        .block {
            min-width: 160px; background: var(--bg-element); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px; cursor: pointer;
        }

        .block.active { border-color: var(--accent-primary); background: rgba(0, 242, 255, 0.1); }

        .terminal {
            background: #000; border-radius: 10px; height: 100px; padding: 12px;
            font-family: monospace; font-size: 0.8rem; color: #00ffaa;
            overflow-y: auto; margin-top: auto; border: 1px solid var(--border);
        }

        /* מסך טעינה */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2,2,8,0.98); z-index: 99999; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }

        .spinner {
            width: 50px; height: 50px; border: 3px solid var(--border);
            border-top-color: var(--accent-primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div style="font-weight: 900; color: #fff; margin-bottom: 10px;">מנוע ה-AI מלחין את היצירה...</div>
    <div style="width: 200px; height: 4px; background: #111; border-radius: 2px; overflow: hidden;">
        <div id="loadProgress" style="width: 0%; height: 100%; background: var(--accent-primary);"></div>
    </div>
</div>

<div class="app-shell">
    <header>
        <div class="brand">
            <i data-lucide="zap" color="var(--accent-primary)"></i>
            <h1>AI MUSIC BEAST <span style="font-size: 0.7rem; opacity: 0.5;">פרו V5.8</span></h1>
        </div>
        <div class="engine-status">
            <div id="timeDisplay">00:00:00</div>
        </div>
    </header>

    <aside>
        <div class="config-card">
            <label><i data-lucide="key" size="14"></i> מפתח API של Gemini</label>
            <div class="input-group">
                <input type="password" id="apiKey" placeholder="הזן מפתח לחיבור...">
                <button class="toggle-btn" onclick="toggleMask()" title="הצג/הסתר">
                    <i id="maskIcon" data-lucide="eye"></i>
                </button>
            </div>
        </div>

        <div class="config-card">
            <label><i data-lucide="message-square" size="14"></i> תיאור השיר המבוקש</label>
            <textarea id="prompt" rows="4" placeholder="תאר את הסגנון, הכלים והקצב המבוקשים..."></textarea>
        </div>

        <button class="btn btn-ai" id="genBtn" onclick="generateMusic()">
            <i data-lucide="cpu"></i> צור שיר חדש
        </button>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn btn-play" id="playBtn" onclick="togglePlay()" disabled>
                <i data-lucide="play" id="playIcon"></i> נגן
            </button>
            <button class="btn btn-stop" onclick="location.reload()">
                <i data-lucide="rotate-ccw"></i> איפוס
            </button>
        </div>

        <button class="btn btn-download" id="exportBtn" onclick="exportWav()" disabled>
            <i data-lucide="download"></i> הורד מאסטר (WAV)
        </button>

        <div id="logs" class="terminal">> המערכת מוכנה לפעולה.</div>
    </aside>

    <main>
        <div class="visual-grid">
            <div class="monitor">
                <span class="monitor-label">ניתוח תדרים</span>
                <canvas id="freqCanvas"></canvas>
            </div>
            <div class="monitor">
                <span class="monitor-label">מתנד פאזה</span>
                <canvas id="phaseCanvas"></canvas>
            </div>
        </div>

        <div class="mixer">
            <div style="display: flex; justify-content: space-between;">
                <h3 style="margin: 0; font-size: 0.8rem; color: var(--text-dim);">מיקסר וירטואלי</h3>
            </div>
            <div class="mixer-grid" id="mixerUI"></div>
        </div>
    </main>

    <footer class="timeline">
        <div class="track" id="timelineUI"></div>
    </footer>
</div>

<script>
/**
 * AI MUSIC BEAST 5.8
 * תיקוני באגים:
 * 1. סנכרון שמות משתנים בין ה-API לממשק (songData).
 * 2. הפרדת הקשר האודיו בין נגינה חיה לרינדור Offline.
 * 3. החזרת הממשק לעברית מלאה.
 */

const INSTRUMENTS = [
    { id: 'kick', name: 'קיק', color: '#ff2d55' },
    { id: 'snare', name: 'סנר', color: '#ff9500' },
    { id: 'hihat', name: 'היי-הט', color: '#ffcc00' },
    { id: 'bass', name: 'בס', color: '#34c759' },
    { id: 'lead', name: 'ליד', color: '#007aff' },
    { id: 'pad', name: 'פד', color: '#af52de' },
    { id: 'fx', name: 'אפקט', color: '#ffffff' }
];

let audioCtx, masterGain, mainAnalyser, phaseAnalyser;
let isPlaying = false;
let songData = null; // משתנה מרכזי לנתוני השיר
let stepIdx = 0;
let blockIdx = 0;
let nextTime = 0;
let loopTimer;
const channels = {};

window.onload = () => {
    lucide.createIcons();
    const saved = localStorage.getItem('beast_key');
    if(saved) document.getElementById('apiKey').value = saved;
    initMixerUI();
};

function toggleMask() {
    const input = document.getElementById('apiKey');
    const icon = document.getElementById('maskIcon');
    const isPass = input.type === 'password';
    input.type = isPass ? 'text' : 'password';
    icon.setAttribute('data-lucide', isPass ? 'eye-off' : 'eye');
    lucide.createIcons();
}

function initMixerUI() {
    const grid = document.getElementById('mixerUI');
    INSTRUMENTS.forEach(inst => {
        const strip = document.createElement('div');
        strip.className = 'channel-strip';
        strip.innerHTML = `
            <div class="vu-container"><div id="vu-${inst.id}" class="vu-bar"></div></div>
            <input type="range" class="fader" id="vol-${inst.id}" min="0" max="1" step="0.01" value="0.7">
            <div style="font-size: 0.6rem; color: ${inst.color}; font-weight: 900;">${inst.name}</div>
        `;
        grid.appendChild(strip);
        channels[inst.id] = { gain: null, analyser: null };
    });
}

function addLog(m) {
    const l = document.getElementById('logs');
    l.innerHTML = `> ${m}<br>` + l.innerHTML;
}

async function startAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    mainAnalyser = audioCtx.createAnalyser();
    phaseAnalyser = audioCtx.createAnalyser();
    
    masterGain.connect(mainAnalyser);
    mainAnalyser.connect(phaseAnalyser);
    phaseAnalyser.connect(audioCtx.destination);

    INSTRUMENTS.forEach(inst => {
        const g = audioCtx.createGain();
        const a = audioCtx.createAnalyser();
        a.fftSize = 32;
        g.connect(a);
        a.connect(masterGain);
        channels[inst.id].gain = g;
        channels[inst.id].analyser = a;
    });
}

async function generateMusic() {
    const key = document.getElementById('apiKey').value;
    const prompt = document.getElementById('prompt').value || "Techno";
    if(!key) return alert("חובה להזין מפתח API!");

    localStorage.setItem('beast_key', key);
    document.getElementById('loader').style.display = 'flex';
    document.getElementById('loadProgress').style.width = '20%';
    addLog("מתחבר לבינה המלאכותית...");

    const sys = `מפיק מוזיקלי אלקטרוני. החזר JSON: {
        "bpm": 128,
        "blocks": [
            { "name": "פתיחה", "kick": [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], "lead": [60,0,60,0,63,0,60,0,65,0,60,0,63,0,62,0] }
        ]
    } ערוצים: kick, snare, hihat, bass, lead, pad, fx. תווים הם MIDI.`;

    try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                contents: [{ parts: [{ text: `צור יצירת ${prompt} מקצועית.` }] }],
                systemInstruction: { parts: [{ text: sys }] }
            })
        });

        const result = await res.json();
        if(!result.candidates) throw new Error("תגובה לא תקינה.");

        let text = result.candidates[0].content.parts[0].text;
        text = text.replace(/```json/g, '').replace(/```/g, '').trim();
        songData = JSON.parse(text); // עדכון המשתנה המרכזי
        
        await startAudio();
        renderTimeline();
        document.getElementById('playBtn').disabled = false;
        document.getElementById('exportBtn').disabled = false;
        addLog(`השיר נוצר בהצלחה! קצב: ${songData.bpm} BPM.`);
    } catch (e) {
        addLog("שגיאה: " + e.message);
    } finally {
        document.getElementById('loadProgress').style.width = '100%';
        setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
    }
}

function renderTimeline() {
    const ui = document.getElementById('timelineUI');
    ui.innerHTML = '';
    songData.blocks.forEach((b, i) => {
        const div = document.createElement('div');
        div.className = 'block';
        div.id = `blk-${i}`;
        div.innerHTML = `<div style="color:var(--accent-primary); font-weight:900;">${b.name}</div><div style="font-size:0.6rem;">16 צעדים</div>`;
        ui.appendChild(div);
    });
}

function scheduler() {
    while (nextTime < audioCtx.currentTime + 0.1) {
        playStep(blockIdx, stepIdx, nextTime);
        const stepLen = 60 / songData.bpm / 4;
        nextTime += stepLen;
        stepIdx++;
        if(stepIdx >= 16) {
            stepIdx = 0;
            blockIdx = (blockIdx + 1) % songData.blocks.length;
            updateActiveUI();
        }
    }
    loopTimer = setTimeout(scheduler, 25);
}

function playStep(bI, sI, t) {
    const blk = songData.blocks[bI];
    if(blk.kick && blk.kick[sI]) triggerDrum('kick', 100, 0.3, t);
    if(blk.snare && blk.snare[sI]) triggerDrum('snare', 300, 0.2, t);
    if(blk.hihat && blk.hihat[sI]) triggerDrum('hihat', 6000, 0.05, t);

    ['bass','lead','pad','fx'].forEach(id => {
        if(blk[id] && blk[id][sI] > 0) {
            triggerSynth(id, m2f(blk[id][sI]), t, 0.25);
        }
    });

    const sec = Math.floor(t);
    document.getElementById('timeDisplay').innerText = 
        `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}:${sI.toString().padStart(2,'0')}`;
}

function m2f(m) { return 440 * Math.pow(2, (m - 69) / 12); }

function triggerDrum(id, freq, dur, t) {
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.frequency.setValueAtTime(freq, t);
    o.frequency.exponentialRampToValueAtTime(0.01, t + dur);
    g.gain.setValueAtTime(0.8, t);
    g.gain.exponentialRampToValueAtTime(0.01, t + dur);
    o.connect(g); g.connect(channels[id].gain);
    o.start(t); o.stop(t + dur);
}

function triggerSynth(id, freq, t, dur) {
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = (id === 'bass') ? 'triangle' : 'sawtooth';
    o.frequency.setValueAtTime(freq, t);
    g.gain.setValueAtTime(0.3, t);
    g.gain.exponentialRampToValueAtTime(0.01, t + dur);
    o.connect(g); g.connect(channels[id].gain);
    o.start(t); o.stop(t + dur);
}

function draw() {
    if(!isPlaying) return;
    requestAnimationFrame(draw);
    
    // ניתוח תדרים
    const fC = document.getElementById('freqCanvas');
    const fCtx = fC.getContext('2d');
    fC.width = fC.offsetWidth; fC.height = fC.offsetHeight;
    const fD = new Uint8Array(mainAnalyser.frequencyBinCount);
    mainAnalyser.getByteFrequencyData(fD);
    fCtx.fillStyle = '#000'; fCtx.fillRect(0,0,fC.width,fC.height);
    fD.forEach((v, i) => {
        const h = (v/255) * fC.height;
        fCtx.fillStyle = `hsl(${i}, 100%, 50%)`;
        fCtx.fillRect(i * (fC.width/fD.length), fC.height-h, 2, h);
    });

    // VU ופיידרים
    INSTRUMENTS.forEach(inst => {
        const d = new Uint8Array(1);
        channels[inst.id].analyser.getByteFrequencyData(d);
        document.getElementById(`vu-${inst.id}`).style.height = `${(d[0]/255)*100}%`;
        const v = document.getElementById(`vol-${inst.id}`).value;
        channels[inst.id].gain.gain.setTargetAtTime(v, audioCtx.currentTime, 0.05);
    });
}

function togglePlay() {
    const icon = document.getElementById('playIcon');
    if(isPlaying) {
        isPlaying = false;
        clearTimeout(loopTimer);
        audioCtx.suspend();
        icon.setAttribute('data-lucide', 'play');
    } else {
        isPlaying = true;
        audioCtx.resume();
        nextTime = audioCtx.currentTime;
        scheduler();
        draw();
        icon.setAttribute('data-lucide', 'pause');
    }
    lucide.createIcons();
}

function updateActiveUI() {
    document.querySelectorAll('.block').forEach(b => b.classList.remove('active'));
    const curr = document.getElementById(`blk-${blockIdx}`);
    if(curr) curr.classList.add('active');
}

async function exportWav() {
    addLog("מתחיל רינדור מאסטר...");
    const sr = 44100;
    const dur = songData.blocks.length * (60/songData.bpm) * 4;
    const off = new OfflineAudioContext(2, sr * dur, sr);
    
    // בתוך ה-OfflineContext יוצרים הכל מחדש כדי למנוע התנגשויות
    songData.blocks.forEach((blk, bIdx) => {
        const bOff = bIdx * (60/songData.bpm) * 4;
        for(let s=0; s<16; s++) {
            const t = bOff + (s * (60/songData.bpm/4));
            if(blk.kick && blk.kick[s]) {
                const o = off.createOscillator();
                const g = off.createGain();
                o.frequency.setValueAtTime(100, t);
                o.frequency.exponentialRampToValueAtTime(0.01, t + 0.3);
                g.gain.setValueAtTime(0.7, t);
                g.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
                o.connect(g); g.connect(off.destination);
                o.start(t); o.stop(t+0.3);
            }
        }
    });

    const buffer = await off.startRendering();
    const blob = bufferToWav(buffer);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `BEAST_MASTER_${Date.now()}.wav`;
    a.click();
    addLog("הקובץ מוכן להורדה!");
}

function bufferToWav(abuffer) {
    let n = abuffer.numberOfChannels, len = abuffer.length * n * 2 + 44,
        buf = new ArrayBuffer(len), view = new DataView(buf),
        ch = [], i, s, off = 0, p = 0;
    function u16(d) { view.setUint16(off, d, true); off += 2; }
    function u32(d) { view.setUint32(off, d, true); off += 4; }
    u32(0x46464952); u32(len - 8); u32(0x45564157);
    u32(0x20746d66); u32(16); u16(1); u16(n);
    u32(abuffer.sampleRate); u32(abuffer.sampleRate * 2 * n);
    u16(n * 2); u16(16); u32(0x61746164); u32(len - off - 4);
    for(i=0; i<n; i++) ch.push(abuffer.getChannelData(i));
    while(p < abuffer.length) {
        for(i=0; i<n; i++) {
            s = Math.max(-1, Math.min(1, ch[i][p]));
            s = (s < 0 ? s * 0x8000 : s * 0x7FFF) | 0;
            view.setInt16(off, s, true); off += 2;
        }
        p++;
    }
    return new Blob([buf], {type: "audio/wav"});
}
</script>
</body>
</html>
